name: docker build and run

on:
  push:
    branches: [ "main", "f/test-ngrok-with-apache" ]
  workflow_dispatch:

jobs:
  build:
    runs-on: ubuntu-latest

    steps:
      - uses: actions/checkout@v3
      - uses: docker/setup-qemu-action@v2
      - uses: docker/setup-buildx-action@v2
      
      - name: download Ngrok
        run: |
          wget https://github.com/vincenthsu/systemd-ngrok/archive/refs/heads/master.zip
          sudo apt install unzip zip -y 
          unzip -d ngrok master.zip
          ls -la
          ls -la ngrok


      - name: docker build
        env:
          NGROK: ${{ secrets.NGROK }}
          NGROKYML: ${{ secrets.NGROKYML }}
        run: |
          echo ${#NGROK}
          echo "NGROK=$NGROK" > secret
          echo $NGROKYML > ngrok.yml
          docker build --build-arg $NGROK -t apacke_ngrok . 
          
      - name: docker run
        run: |
          docker run apacke_ngrok
